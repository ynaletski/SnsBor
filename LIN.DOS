
      Контроллер системы учета отпуска СУГ.

      Контроллер поддерживает протокол обмена Modbus RTU для подчиненного
   (Slave) устройства , т.е. отвечает на запросы посланные Host.
      Поддерживаются функции Modbus: 3,6,16.
      Контроллеру присвоен  адрес  01  в магистрали Modbus.
      Параметры асинхронного последовательного канала связи :
       19200 бод, 8 бит данных, без контроля четности, 1 стоп.бит.
       Физический канал связи RS485.

    В контроллере используется 2 типа регистров:
     - целочисленные (16 бит), далее Int;
     - регистры с плавающей запятой формата IEEE (32 бита), далее Float.

    Регистры типа Int имеют адреса 0...20 .
    Один регистр типа Int  занимает один адрес в адресном пространстве.
   Соответственно обозначаются I0...I20. Например:
      I7   Регистр команды
      I8   Регистр подтверждения команды
      I9   Регистр состояния
      I10  Регистр ошибок

     Регистры типа Float  имеют адреса 1000...1182 .
  Один регистр типа Float занимает 2 адреса в адресном пространстве.
     Соответственно обозначаются F1000...F1182.
     Для пересылки регистр Float разбивается на 2 регистра по 16 бит.
     Сначала передается младший регистр (D0-D15), затем старший (D16-D31).
   При передаче 16 битного регистра, согласно Modbus, первым передается
      старший байт.

  Данные регистров  доступны по чтению - функция Modbus 03 и записи
   - функции Modbus 06,16.

    Доступны по чтению все регистры из списка регистров Int и Float(см.ниже).

    Доступны по записи:
    - регистр команды I7;
    - регистр операнда команды (доза приема): F1000;
    - регистр I14 (Период сторожевого таймера канала связи,ms)

    Запись в регистры с другими адресами не запрещена, но записанные данные
  будут изменены на актуальные значения в процессе работы системы.
    Например, при модификации через Modbus данных, относящихся к расходомеру N1,
  записанные данные сохранятся до приема новых данных из расходомера N1.

   Описание соответствует системе включающей 3 резервуара и 2 ГРК.
   При меньшем количестве резервуаров и ГРК данные соответствующие
 отсутствующим компонентам системы не заполняются.
   Количество резервуаров и ГРК , входящих в состав системы учета ,
 содержится в регистрах I19,I20 соответственно.

   -----------------------


    Система учета СУГ может функционировать в следующих режимах:

    1. Режим хранения.
    2. Работа в режиме ГРК. Отпуск по объему.
     Команда на отпуск через соответствующую ГРК приниматся  по отдельному
    каналу связи для каждой ГРК с использованием протокола Pumalan (Marconi).
    3. Прием СУГ от газовоза по массе.
    4. Измерение плотности в резервуаре N1,N2(,N3) .

     Во всех режимах осуществляется контроль состояния резервуаров
  по сигналам уровнемеров Digimag ( уровень и температура жидкой фазы)
  и дополнительным  датчикам температуры и давления паровой фазы.

    При отпуске СУГ через ГРК выполняется массовый и объемный учет жидкой фазы
  СУГ.
    При приеме СУГ от газовоза выполняется массовый и объемный учет жидкой
  и паровой фаз СУГ.

   Для изменения режима работы системы учета СУГ используется набор команд.

-------------------------------

    Использование команд управления контроллером.

    Общие положения.

    Команда из набора команд (см.ниже) записывается в регистр команды I7.

    Если команда не может быть выполнена на момент приема команды по Modbus,
   в ответ на соответствующую функцию (06 или 16) будет передано сообщение
   об ошибке (исключении) с кодом исключения 03 - "Запрещенное значение
   данных", т.е. команда будет отвергнута.
     При этом в регистр подтверждения команды I8  запишется код принятой
   команды с установленным  битом  0x8000.

    Если в процессе обработки команды (после ответа по Modbus) выяснится, что
  команда не может быть выполнена, в регистр подтверждения команды I8
  запишется код принятой команды с установленным битом  0x8000.

    Если команда может быть выполнена, она переписывается в
  Регистр подтверждения команды I8 с установленным битом  0x4000.
    После успешного выполнения команды , бит 0x4000
  в регистре I8 очищается.

   Сотояние  выполнения команды отображается в регистре I9 (кодировку см.ниже).
   Состояние ошибок контроллера отображается в регистре I10 (кодировку см.ниже).

   Команды со следующими кодами  будут приняты к исполнению только
  при значениях регистров состояния и ошибок равных нулю
  (т.е. (I9==0) && (I10==0)):

  Код
 команды
     1   - запуск приема СУГ;.
    21   - запуск измерения плотности в резервуаре N1;
    22   - запуск измерения плотности в резервуаре N2;
    23   - запуск измерения плотности в резервуаре N3;

==============================================================================

   Набор команд контроллера (код команды записываемый в I7 ):

     1 - запуск приема СУГ.
     2 - останов процесса приема СУГ и измерения плотности СУГ.
     3 - экстренный останов процесса приема СУГ и измерения плотности СУГ.
     4 - сброс контроллера (равносильно выключению/включения питания).
     5 - очистка регистра ошибок,
     6 - останов отпуска через ГРК
     8 - подтверждение чтения данных результата приема,
          очищает бит 0x80 в регистре состояния.
     9 - подтверждение чтения данных результата изм.плотности в резервуаре 1
          очищает бит 0x800 в регистре состояния.
    10 - подтверждение чтения данных результата изм.плотности в резервуаре 2
          очищает бит 0x800 в регистре состояния.
    11 - отмена ввода данных результатов изм.плотности в резервуаре 1,2
          очищает бит 0x800 в регистре состояния.
    12 - подтверждение чтения данных результата изм.плотности в резервуаре 3
          очищает бит 0x800 в регистре состояния.

    21 - запуск измерения плотности в резервуаре 1
    22 - запуск измерения плотности в резервуаре 2
    23 - запуск измерения плотности в резервуаре 3

    256 - запрет старта отпуска через ГРК1,ГРК2
     0 - разрешение отпуска через ГРК1,ГРК2 и включения приема,изм.плотн. от ВРФ
    4096 - разрешение отпуска через ГРК1,ГРК2, запрет включения
       приема,изм.плотн. от ВРФ

      Команды с кодами 1, 21, 22, 23  будут приняты к исполнению только
    при значениях регистров состояния и ошибок равных нулю : I9==0, I10==0.

----------
      Разряды , устанавливаемые в Регистре подтверждения команды в процессе
   обработки команды.
   0x4000 - бит выполнения команды
   0x8000 - бит невозможности выполнения команды.
-------------------------------

      Битовая кодировка регистра состояний I9:

             1  - отпуск через ГРК1
          0x10  - прием СУГ в процессе выполнения
          0x20  - прием СУГ остановлен по прекращению потока
          0x40  - прием в процессе выполнения, промежуточная стадия
          0x80  - прием СУГ завершен, результат приема
                  в F1004,F1006,F1008,F1010;
          0x100 - измерение плотности СУГ в процессе выполнения
          0x800 - измерение плотности СУГ завершено, данные в F1072,F1074;
         0x8000 - ошибка ,(код ошибки в регистре ошибок I10 != 0)
-------------------------------

    Битовая кодировка регистра ошибок I10:
    При наличии ошибки соответствующий бит устанавливается.
    I10 == 0 - ошибок нет.
       D0...D9 - ошибка, биткодированная по модулям
          D0 - Дисплей ВРФ
          D1 - Расходомер N1
          D2 - Расходомер N2
          D3 - Дисплей трехстрочный
          D4 - Модуль дискретного ввода-вывода N1 (I7044)
          D5 - Модуль дискретного ввода-вывода N2 (I7044)
          D6 - Модуль аналогового ввода-вывода N2 (I7017)
          D7 - Контроллер N1 (I7188XA)
          D8 - уровнемер N1
          D9 - уровнемер N2

         D10...D15 - ошибка функционирования,
          биткодированная:
        0x400  - зафиксирован предельный уровень при приеме,
           измерении плотности
        0x800  - нажата аварийная кнопка
        0x1000 - нет сигнала УЗА при приеме СУГ
        0x2000 - логическая ошибка связи с расходомером
        0x4000 - нет связи с базой ГРК ( таймаут по приему команды)
                ошибка фиксируется только в режиме отпуска через ГРК.
        0x8000 - прочие ошибки.

-------------------------------

      Битовая кодировка регистра I11 - состояние предельных уровней резервуаров.

        0x20  - в одном из резервуаров зафиксирован объем менее 10%
                от общего объема резервуара
        0x40  - в одном из резервуаров зафиксирован объем более 90%
                от общего объема резервуара

-------------------------------


      Битовая кодировка регистра состояний I15:

             1  - отпуск через ГРК
         0x8000 - ошибка ,(код ошибки в регистре ошибок I16 != 0)
-------------------------------

    Битовая кодировка регистра ошибок I16:
    При наличии ошибки соответствующий бит устанавливается.
    I10 == 0 - ошибок нет.
       D0...D9 - ошибка, биткодированная по модулям
          D0 - Дисплей ВРФ
          D1 - Расходомер ГРК2
          D2 - = 0 (не используется)
          D3 - Дисплей трехстрочный
          D4 - Модуль дискретного ввода-вывода N1 (I7044)
          D5 - = 0 (не используется)
          D6 - = 0 (не используется)
          D7 - = 0 (не используется)
          D8 - = 0 (не используется)
          D9 - = 0 (не используется)

         D10...D15 - ошибка функционирования,
          биткодированная:
        0x400  - зафиксирован предельный уровень при приеме,
        0x800  - нажата аварийная кнопка
        0x1000 - нет сигнала УЗА при приеме СУГ
        0x2000 - логическая ошибка связи с расходомером
        0x4000 - нет связи с базой ГРК ( таймаут по приему команды)
                ошибка фиксируется только в режиме отпуска через ГРК.
        0x8000 - прочие ошибки.

-------------------------------

  Список регистров Int

  I0  колич.перем int
  I1  колич.перем float
  I2  Резерв
  I3  Резерв
  I4  Версия ПО, 6 ASCII символов
  I5   -"-
  I6   -"-
  I7   Регистр команды
  I8   Регистр подтверждения команды
  I9   Регистр состояния
  I10  Регистр ошибок
  I11  Состояние предельных уровней резервуаров
  I12  Состояние дискретных выходов ГРК1
  I13  Состояние дискретных входов  ГРК1
  I14  Период сторожевого таймера канала связи, ms  0 - таймер отключен
  I15  Регистр состояния ГРК2
  I16  Регистр ошибок    ГРК2
  I17  Состояние дискретных входов контроллера ГРК N2
  I18  Состояние дискретных выходов контроллера ГРК N2
  I19  Количество резервуаров в системе:  1...3
  I20  Количество ГРК в системе        :  1...2

      Список регистров Float

  F1000   операнд команды
  F1002   копия операнда

  F1004   Масса в операции приема,кг.
  F1006   Объем в операции приема,л.
  F1008   Средняя плотность в операции приема,кг/м3.
  F1010   Средняя температура в операции приема,C.

  F1012   Измеренное значение плотности жидкости в резервуаре N1,кг/м3
  F1014   Температура при измерении плотности в резервуаре N1,C
  F1016   Измеренное значение плотности жидкости в резервуаре N2,кг/м3
  F1018   Температура при измерении плотности в резервуаре N2,C

          Данные о состоянии резервуаров

  F1020   Масса жидкой фазы в резервуаре N1, кг
  F1022   Объем жидкой фазы в резервуаре N1,л

  F1024   Масса паровой фазы в резервуаре N1, кг
  F1026   Объем паровой фазы в резервуаре N1,л

  F1028   Масса жидкой фазы  в резервуаре N2, кг
  F1030   Объем жидкой фазы  в резервуаре N2,л

  F1032   Масса паровой фазы  в резервуаре N2, кг
  F1034   Объем паровой фазы  в резервуаре N2,л

  F1036   Плотность жидкой фазы в резервуаре N1,кг/м3
  F1038   Плотность паровой фазы в резервуаре N1,кг/м3

  F1040   Плотность жидкой фазы в резервуаре N2,кг/м3
  F1042   Плотность паровой фазы в резервуаре N2,кг/м3

  F1044   Температура жидкой фазы в резервуаре N1, C
  F1046   Уровень жидкой фазы  в резервуаре N1,мм
           (первичные данные из уровнемера)

  F1048   Температура жидкой фазы в резервуаре N2, C
  F1050   Уровень жидкой фазы  в резервуаре N2,мм
           (первичные данные из уровнемера)

          Данные датчиков давления , температуры

  F1052   Давление в расходомере,МПа
  F1054   Давление в резервуаре N1,МПа
  F1056   Давление в резервуаре N2,МПа
  F1058   Температура паров в резервуаре N1,C
  F1060   Температура паров в резервуаре N2,C

          Данные из расходомера N1 (жидкая фаза)

  F1062   Масса инвентарная ( накапливающий счетчик)
  F1064   Масса в текущей операции отпуска (total)
  F1066   Объем инвентарный ( накапливающий счетчик)
  F1068   Объем в текущей операции отпуска (total)
  F1070   Массовый расход, кг/ч
  F1072   Плотность кг/м3
  F1074   Температура в полости расходомера,C

            (для совместимости с системой с 2-мя расходомерами)
  F1076   Масса СУГ отпущенного через ГРК(1),кг.Накапливающий счетчик.
  F1078   Объем СУГ отпущенного через ГРК(1),л.Накапливающий счетчик.

          Данные из расходомера N2 ( паровая фаза )

  F1080   Масса инвентарная ( накапливающий счетчик)
  F1082   Масса в текущей операции отпуска (total)
  F1084   Объем инвентарный ( накапливающий счетчик)
  F1086   Объем в текущей операции отпуска (total)
  F1088   Массовый расход, кг/ч
  F1090   Плотность кг/м3
  F1092   Температура,C

  F1094   Общий объем резервуара 1,л
  F1096   Минимальнодопустимый объем жидкой фазы в рез.1,л
  F1098   Максимальнодопустимый объем жидкой фазы в рез.1,л

  F1100   Общий объем резервуара 2,л
  F1102   Минимальнодопустимый объем жидкой фазы в рез.1,л
  F1104   Максимальнодопустимый объем жидкой фазы в рез.1,л

       Данные резервуара N3

  F1106  53 Измеренное значение плотности жидкости в резервуаре N2,кг/м3
  F1108  54 Температура при измерении плотности в резервуаре N2,C
  F1110  55 Масса жидкости в резервуаре N3, кг
  F1112  56 Объем жидкости в резервуаре N3,л
  F1114  57 Масса газа в резервуаре N3, кг
  F1116  58 Объем газа в резервуаре N3,л
  F1118  59 Плотность жидкой фазы в резервуаре N3,кг/м3
  F1120  60 Плотность паровой фазы в резервуаре N3,кг/м3
  F1122  61 Температура жидкой фазы в резервуаре N3, C (первичные данные из уровнемера)
  F1124  62 Уровень жидкости в резервуаре N3,мм (первичные данные из уровнемера)
  F1126  63 Давление в резервуаре N3,МПа  (сигнал аналогового датчика)
  F1128  64 Температура паров в резервуаре N3,C (сигнал аналогового датчика)
  F1130  65 Общий объем резервуара 2,л
  F1132  66 Минимальнодопустимый объем жидкой фазы в рез.1,л
  F1134  67 Максимальнодопустимый объем жидкой фазы в рез.1,л

         Данные из расходомера N3 ( ГРК1 , отпуск )

  F1136  68 Масса инвентарная ( накапливающий счетчик) == Масса СУГ отпущенного через ГРК1,кг.Накапливающий счетчик.
  F1136  69 Масса в текущей операции отпуска (total)
  F1140  70 Объем инвентарный ( накапливающий счетчик) == Объем СУГ отпущенного через ГРК1,л. Накапливающий счетчик.
  F1142  71 Объем в текущей операции отпуска (total)
  F1144  72 Массовый расход, кг/ч
  F1146  73 Плотность кг/м3
  F1148  74 Температура в полости расходомера,C

         Данные из расходомера N4 ( ГРК2 , отпуск )

  F1150  75 Масса инвентарная ( накапливающий счетчик) == Масса СУГ отпущенного через ГРК2,кг.Накапливающий счетчик.
  F1152  76 Масса в текущей операции отпуска (total)
  F1154  77 Объем инвентарный ( накапливающий счетчик) == Объем СУГ отпущенного через ГРК2,л. Накапливающий счетчик.
  F1156  78 Объем в текущей операции отпуска (total)
  F1158  79 Массовый расход, кг/ч
  F1160  80 Плотность кг/м3
  F1162  81 Температура в полости расходомера,C

  F1164  82 Резерв
  F1166  83 Резерв
  F1168  84 Резерв
  F1170  85 Резерв
  F1172  86 Резерв
  F1174  87 Резерв
  F1176  88 Резерв
  F1178  89 Резерв

  F1180  90 Частота обмена по Modbus
  F1182  91 Резерв

-------------------------------

   Пример последовательности действий с контроллером.


1.   Прием СУГ от газовоза.

   Открыть соответствующие вентили для подключения требуемого резервуара.

1.1. Записать значение дозы приема в литрах в регистр
     типа float с адресом 1000(d)  (F1000).
  (далее: F1000=xxxx;)

1.2.  Записать в регистр команды типа Int с адресом 7 значение 1
  (далее: I7=1;)
   I7  = 1; - запустить режим приема от газовоза.

    Если в момент передачи команды записи в регистр I7=1 ,
   значение (F1000 == 0) , или (I9 != 0 ) или (I10 != 0)
   в ответ будет передано сообщение об ошибке (исключении) с кодом
   исключения 03 - "Запрещенное значение данных".
     При этом в регистр подтверждения команды I8 запишется значение
    0x8001 .

    При успешном приеме команды значение регистра F1000 перепишется
  в регистр F1002.
    Регистр F1000 обнулится.

1.3.   Дождаться , опрашивая состояние регистров I8,I9,I10 , появления
 значений  1, 0x010 ,0 соответственно.
  ( Далее: дождаться I8==1 , I9==0x010, I10==0 .)
    Дождаться I8==1  , I9==0x010, I10==0 .
                              |        |
                       прием СУГ       |
                              нет ошибок
  При этом:

  F1004 - Текущее значение массы СУГ принятой от газовоза (жидкой и паровой
           фазы) , кг
  F1006 - Текущее значение объема СУГ принятого от газовоза, л
  F1072 - текущее значение плотности потока жидкой фазы,кг/м3.
  F1074 - текущее значение температуры потока жидкой фазы,C.
  F1090 - текущее значение плотности потока паровой фазы,кг/м3.
  F1092 - текущее значение температуры потока паровой фазы,C.

  После приема заданной дозы, прием будет остановлен автоматически.

1.4.Дождаться I8==1 , I9==0x80, I10==0 .
                          |        |
          прием. завершен.|        |
                           нет ошибок

   Прием прекратится при исчезновении сигала УЗА, при нажатии на кнопку
 аврийного останова или при достижении предельного уровня наполнения
 резервуара.При этом соответствующий бит будет установлен
 в регистре ошибок I10.

   Прием также прекратится автоматически при снижении расхода
 ниже предельного уровня. При этом в регистре состояний будет
 установлен бит 0x20.

1.5.1   При необходимости остановить прием до завершения приема заданной дозы,
  необходимо послать команду:
  I7=2; - остановить прием СУГ. При этом клапаны и насос будут выключены
       в нужной последовательности для предотвращения гидравлического
       удара.

1.5.2   При необходимости экстренного останова приема до завершения
 приема заданной дозы, необходимо послать команду:
  I7=3; - экстренный останов приема СУГ. При этом клапаны и насос будут
     выключены незамедлительно.

  Дождаться I8==3, I9==0x8080,   I10==8000 .
                         | |          |
                         | |          |
            регистр ошибок |          |
            не равен 0     |          |
                           |          |
            прием. завершен.          |
                               Аварийный останов

1.6.  После остановки приема во всех случаях в регистре состояния I9
 устанавливается бит 0x80. Это указывает на наличие данных о результатах
 приема :

 F1004 - Масса СУГ принятого от газовоза (жидкой и паровой фаз),кг.
 F1006 - Объем СУГ принятого от газовоза приведенный к плотности жидкой фазы,л.
 F1008 - Средняя плотность в операции приема,кг/м3.
 F1010 - Средняя температура в операции приема,C.

   Масса СУГ принятого от газовоза является фискально учитываемой величиной.
   Данные следует прочитать и использовать ( при выписке накладной, например).

1.7.  После того как данные о результатах приема прочитаны, следует очистить
 бит 0x80 в регистре состояния командой подтверждения чтения данных
 результата приема:
   I7=8;

  При этом бит 0x80 в регистре состояний будет очищен.

  Без использования команды I7=8; последующие команды
 приема СУГ, измерения плотности СУГ будут отвергнуты.

==============================================================================

    Операции по измерению  плотности в резервуарах.

   2. Измерение плотности в резервуаре N1:
      Необходимо открыть соответствующие вентили.

   2.1. Записать в регистр команды типа Int с адресом 7 значение 21
  I7  = 21; - запустить режим измерения плотности.

   2.2. Дождаться , опрашивая состояние регистров I8,I9,I10 появления
 значений 21,0x100,0 соответственно.
 ( Далее: дождаться I8==3 , I9==0x100, I10==0 .)

           I8==21 , I9==0x100, I10==0.
               |          |         |
    Подтв.команды         |         |
         измерение плотности        |
                            нет ошибок

  При этом F1072 - текущее значение плотности в потоке,кг/м3
           F1074 - текущее значение температуры потока,C.
    Дождаться установившегося режима по температуре. За 20 сек изменение.
  температуры не должно превышать 0.3 градуса.

   2.3. I7=2;  - остановить режим измерения плотности

   2.4.  Дождаться I8==2 , I9==0x800, I10==0.
                          |        |
        изм.плотн. заверш.|
                          нет ошибок

  При этом F1072 - измеренное значение плотности
           F1074 - измеренное значение температуры.

   2.5.1  Для ввода полученных данных и использования в последующих
       вычислениях массы  СУГ :
   I7=9;
  Дождаться I8==9 , I9==0x000, I10==0 .
  При этом значения F1072,F1074 запишутся в F1012, F1014 соответственно и
 с этого момента будут использоваться для вычисления массы СУГ в резервуаре N1.
  При этом бит 0x800 в регистре состояний будет очищен.

   2.5.2 Для отмены ввода полученных данных :
   I7=11;
  Дождаться I8==11, I9==0x000, I10==0.
  При этом бит 0x800 в регистре состояний будет очищен.

   Без использования команд (I7=9; или I7=11;) последующие команды
 приема СУГ, измерения плотности СУГ будут отвергнуты.

 ---------

       3. Измерение плотности в резервуаре N2 (N3):
     Необходимо открыть соответствующие вентили.

  3.1.  I7  = 22 (23); - запустить режим измерения плотности.

  3.2. Дождаться I8==22(23) , I9==0x100, I10==0 .
                          |         |
         измерение плотности        |
                            нет ошибок

  При этом F1072 - текущее значение плотности в потоке кг/м3
           F1074 - текущее значение температуры потока,C.
    Дождаться установившегося режима по температуре. За 20 сек изменение
    температуры не должно превышать 0.3 градуса.

  3.3.  I7=2;  - остановить режим измерения плотности

  3.4.  Дождаться I8==2 , I9==0x800, I10==0 .
                          |         |
        изм.плотн. заверш.|
                            нет ошибок

  При этом F1072 - измеренное значение плотности
           F1074 - измеренное значение температуры.

  3.5.1  Для ввода полученных данных и использования в последующих
    вычислениях массы  СУГ :
   I7=10;
  Дождаться I8==10 , I9==0x000, I10==0 .
   При этом значения F1072,F1074 запишутся в F1116, F1118 соответственно и
   с этого момента будут использоваться для вычисления
   массы СУГ в резервуаре N2.
   При этом бит 0x800 в регистре состояний будет очищен.

  3.5.2  Для отмены ввода полученных данных
   I7=11;
  Дождаться I8==11 , I9==0x000, I10==0 .
  При этом бит 0x800 в регистре состояний будет очищен.

   Без использования команд (I7=10; или I7=11;) последующие команды
  приема СУГ, измерения плотности СУГ  будут отвергнуты.

